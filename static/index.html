<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Advisor Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f1115; --card: #1a1d21; --nav: #15171b;
            --text: #e0e0e0; --sub: #9ca3af; --accent: #3b82f6;
            --up: #10b981; --down: #ef4444; --warn: #f59e0b;
            --border: #2d3748;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Inter',sans-serif; background:var(--bg); color:var(--text); height:100vh; display:flex; flex-direction:column; overflow:hidden; }

        /* GNB */
        .gnb { background:var(--nav); border-bottom:1px solid var(--border); padding:0 20px; height:56px; display:flex; align-items:center; justify-content:space-between; flex-shrink:0; }
        .logo { font-size:1.1rem; font-weight:700; color:#fff; display:flex; align-items:center; gap:8px; }
        .nav-links { display:flex; gap:2px; height:100%; }
        .nav-item { padding:0 16px; height:100%; display:flex; align-items:center; color:var(--sub); font-size:0.9rem; font-weight:500; cursor:pointer; border-bottom:2px solid transparent; transition:all .2s; user-select:none; }
        .nav-item:hover { color:#fff; background:rgba(255,255,255,.03); }
        .nav-item.active { color:var(--accent); border-bottom-color:var(--accent); }
        .status-chip { font-size:0.78rem; padding:3px 10px; border-radius:20px; font-weight:600; }
        .chip-on  { background:rgba(16,185,129,.15); color:var(--up); border:1px solid rgba(16,185,129,.3); }
        .chip-off { background:rgba(239,68,68,.15); color:var(--down); border:1px solid rgba(239,68,68,.3); }

        /* Layout */
        .main-container { flex:1; overflow-y:auto; padding:18px 20px; max-width:1900px; margin:0 auto; width:100%; }
        .page-section { display:none; animation:fadeIn .25s ease; }
        .page-section.active { display:block; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(4px)} to{opacity:1;transform:translateY(0)} }

        /* Cards */
        .card { background:var(--card); border-radius:10px; padding:18px; border:1px solid var(--border); }
        .card-title { font-size:1rem; font-weight:600; margin-bottom:14px; display:flex; align-items:center; justify-content:space-between; }
        .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
        .grid-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px; }
        .grid-main { display:grid; grid-template-columns:3fr 1fr; gap:16px; }

        /* Tables */
        .tbl-wrap { overflow-x:auto; }
        table { width:100%; border-collapse:collapse; }
        th { text-align:left; color:var(--sub); font-size:0.8rem; padding:10px 8px; border-bottom:1px solid var(--border); position:sticky; top:0; background:var(--card); white-space:nowrap; }
        td { padding:12px 8px; border-bottom:1px solid #1e2430; font-size:0.88rem; vertical-align:middle; }
        tr:last-child td { border-bottom:none; }
        tr:hover td { background:rgba(255,255,255,.02); }
        .ticker-cell { font-weight:700; color:#fff; }
        .sub-text { font-size:0.75rem; color:var(--sub); display:block; }

        /* Color helpers */
        .up { color:var(--up); } .down { color:var(--down); } .warn { color:var(--warn); }
        .badge { padding:3px 7px; border-radius:4px; font-size:0.72rem; font-weight:700; display:inline-block; white-space:nowrap; }
        .b-up   { background:rgba(16,185,129,.15); color:var(--up);   border:1px solid rgba(16,185,129,.25); }
        .b-down { background:rgba(239,68,68,.15);  color:var(--down); border:1px solid rgba(239,68,68,.25); }
        .b-warn { background:rgba(245,158,11,.15); color:var(--warn); border:1px solid rgba(245,158,11,.25); }
        .b-gray { background:#2d3748; color:#a0aec0; }

        /* Buttons */
        .btn { padding:7px 14px; border-radius:6px; font-size:0.85rem; font-weight:600; cursor:pointer; border:none; transition:all .2s; }
        .btn-primary  { background:var(--accent); color:#fff; }
        .btn-primary:hover  { background:#2563eb; }
        .btn-success  { background:#065f46; color:var(--up); border:1px solid rgba(16,185,129,.4); }
        .btn-success:hover  { background:#047857; }
        .btn-danger   { background:#7f1d1d; color:var(--down); border:1px solid rgba(239,68,68,.4); }
        .btn-danger:hover   { background:#991b1b; }
        .btn-outline  { background:transparent; border:1px solid var(--border); color:var(--sub); }
        .btn-outline:hover  { border-color:var(--text); color:var(--text); }
        .btn-sm { padding:4px 10px; font-size:0.78rem; }

        /* Inputs */
        input, select, textarea { width:100%; padding:9px 10px; background:#252a33; border:1px solid #3d4a5c; color:#fff; border-radius:6px; font-size:0.9rem; outline:none; font-family:inherit; }
        input:focus, select:focus { border-color:var(--accent); }
        label { display:block; color:var(--sub); font-size:0.8rem; margin-bottom:5px; }

        /* Macro bar */
        .macro-bar { display:flex; gap:10px; overflow-x:auto; padding-bottom:12px; margin-bottom:14px; }
        .macro-chip { background:var(--card); padding:10px 14px; border-radius:8px; min-width:130px; border:1px solid var(--border); flex-shrink:0; }
        .macro-chip .mc-label { font-size:0.72rem; color:var(--sub); }
        .macro-chip .mc-val   { font-size:1rem; font-weight:700; margin-top:3px; }
        .macro-chip .mc-sub   { font-size:0.72rem; margin-top:1px; }

        /* Regime gauge */
        .gauge-wrap { text-align:center; padding:10px 0; }
        .gauge-arc { width:160px; height:80px; margin:0 auto; position:relative; }
        .gauge-arc svg { width:100%; height:100%; }
        .gauge-score { font-size:2.5rem; font-weight:800; line-height:1; }
        .gauge-label { font-size:0.8rem; color:var(--sub); }
        .component-bar { display:flex; gap:6px; margin-top:12px; border-radius:6px; overflow:hidden; height:10px; }
        .component-seg { height:100%; border-radius:2px; }

        /* Score breakdown */
        .score-row { display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid var(--border); }
        .score-row:last-child { border-bottom:none; }
        .score-bar-wrap { width:100px; background:#252a33; border-radius:4px; height:6px; }
        .score-bar-fill { height:100%; border-radius:4px; transition:width .5s; }

        /* Sector weights */
        .sector-row { padding:10px 0; border-bottom:1px solid var(--border); }
        .sector-row:last-child { border-bottom:none; }
        .sector-bar-outer { width:100%; background:#252a33; border-radius:4px; height:8px; position:relative; margin:5px 0; }
        .sector-bar-fill2 { height:100%; border-radius:4px; transition:width .6s; }
        .sector-target-line { position:absolute; top:-3px; width:2px; height:14px; background:rgba(255,255,255,.55); border-radius:1px; }
        .sector-mini-bar { width:100%; background:#252a33; border-radius:3px; height:5px; margin:3px 0; position:relative; }
        .sector-mini-fill { height:100%; border-radius:3px; transition:width .5s; }

        /* Modal */
        .modal-backdrop { display:none; position:fixed; inset:0; background:rgba(0,0,0,.65); z-index:200; align-items:center; justify-content:center; backdrop-filter:blur(4px); }
        .modal-backdrop.open { display:flex; }
        .modal-box { background:#1a202c; border:1px solid #2d3748; border-radius:12px; padding:28px; width:420px; max-width:95vw; box-shadow:0 20px 40px rgba(0,0,0,.5); }
        .modal-title { font-size:1.1rem; font-weight:700; margin-bottom:20px; }
        .form-group { margin-bottom:16px; }

        /* Toggle switch */
        .toggle-wrap { display:flex; align-items:center; gap:12px; }
        .toggle { position:relative; width:52px; height:28px; }
        .toggle input { opacity:0; width:0; height:0; }
        .toggle-slider { position:absolute; inset:0; background:#3d4a5c; border-radius:14px; cursor:pointer; transition:.3s; }
        .toggle-slider:before { content:''; position:absolute; width:20px; height:20px; left:4px; bottom:4px; background:#fff; border-radius:50%; transition:.3s; }
        .toggle input:checked + .toggle-slider { background:var(--up); }
        .toggle input:checked + .toggle-slider:before { transform:translateX(24px); }

        /* Scrollbar */
        ::-webkit-scrollbar { width:6px; height:6px; }
        ::-webkit-scrollbar-track { background:var(--bg); }
        ::-webkit-scrollbar-thumb { background:#3d4a5c; border-radius:3px; }
        ::-webkit-scrollbar-thumb:hover { background:#4a5568; }

        /* Misc */
        .empty { text-align:center; padding:30px; color:var(--sub); font-size:0.9rem; }
        .divider { border:none; border-top:1px solid var(--border); margin:16px 0; }
        .row { display:flex; gap:12px; }
        .col { flex:1; }
        .mt { margin-top:16px; }
        .section-title { font-size:0.95rem; font-weight:600; margin-bottom:12px; color:var(--sub); text-transform:uppercase; letter-spacing:.05em; }

        /* Login overlay */
        #login-overlay { display:none; position:fixed; inset:0; background:var(--bg); z-index:1000; align-items:center; justify-content:center; flex-direction:column; }
        #login-overlay.show { display:flex; }
        .login-box { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:40px 36px; width:360px; box-shadow:0 20px 60px rgba(0,0,0,.6); }
        .login-logo { font-size:1.4rem; font-weight:800; color:#fff; text-align:center; margin-bottom:6px; }
        .login-sub { font-size:.82rem; color:var(--sub); text-align:center; margin-bottom:28px; }
        .login-box input { margin-bottom:12px; }
        .login-error { color:var(--down); font-size:.82rem; text-align:center; margin-bottom:10px; min-height:18px; }
        .login-btn { width:100%; padding:11px; border-radius:7px; background:var(--accent); color:#fff; font-size:.95rem; font-weight:700; cursor:pointer; border:none; transition:.2s; margin-top:4px; }
        .login-btn:hover { background:#2563eb; }
        .login-btn:disabled { background:#374151; color:var(--sub); cursor:not-allowed; }
    </style>
</head>
<body>

<!-- Login Overlay -->
<div id="login-overlay">
    <div class="login-box">
        <div class="login-logo">ğŸš€ Stock Advisor Pro</div>
        <div class="login-sub">Sean's Private Dashboard</div>
        <div>
            <label>ì•„ì´ë””</label>
            <input type="text" id="login-id" placeholder="ID" autocomplete="username" onkeydown="if(event.key==='Enter') doLogin()">
        </div>
        <div>
            <label>ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" id="login-pw" placeholder="Password" autocomplete="current-password" onkeydown="if(event.key==='Enter') doLogin()">
        </div>
        <div class="login-error" id="login-error"></div>
        <button class="login-btn" id="login-btn" onclick="doLogin()">ë¡œê·¸ì¸</button>
    </div>
</div>

<!-- GNB -->
<nav class="gnb">
    <div class="logo">ğŸš€ Stock Advisor Pro</div>
    <div class="nav-links">
        <div class="nav-item active" data-tab="dashboard"  onclick="switchTab(this,'dashboard')">Dashboard</div>
        <div class="nav-item" data-tab="portfolio"  onclick="switchTab(this,'portfolio')">Portfolio</div>
        <div class="nav-item" data-tab="market"     onclick="switchTab(this,'market')">Market</div>
        <div class="nav-item" data-tab="trading"    onclick="switchTab(this,'trading')">Trading</div>
        <div class="nav-item" data-tab="macro"      onclick="switchTab(this,'macro')">Macro</div>
        <div class="nav-item" data-tab="settings"   onclick="switchTab(this,'settings')">Settings</div>
    </div>
    <div style="display:flex;align-items:center;gap:12px">
        <span id="strategy-chip" class="status-chip chip-off">ì „ëµ OFF</span>
        <span id="last-updated" style="font-size:0.78rem;color:var(--sub)">-</span>
        <button class="btn btn-outline btn-sm" onclick="logout()" style="font-size:.75rem">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
</nav>

<div class="main-container">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     1. DASHBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="dashboard" class="page-section active">
    <div class="macro-bar" id="macro-bar">
        <div class="macro-chip"><div class="mc-label">Loading...</div></div>
    </div>
    <div class="grid-main">
        <div class="card">
            <div class="card-title">
                <span>ğŸ“Š Portfolio</span>
                <div style="display:flex;gap:8px">
                    <button class="btn btn-outline btn-sm" onclick="syncPortfolio()">ğŸ”„ KIS ë™ê¸°í™”</button>
                    <button class="btn btn-primary btn-sm" onclick="openTradeModal()">+ ë§¤ë§¤ ê¸°ë¡</button>
                </div>
            </div>
            <div class="tbl-wrap" style="max-height:65vh;overflow-y:auto">
                <table>
                    <thead><tr>
                        <th>ì¢…ëª©</th><th>í˜„ì¬ê°€</th><th>ë“±ë½</th><th>ë§¤ìˆ˜ê°€</th><th>ìˆ˜ëŸ‰</th>
                        <th>ìˆ˜ìµë¥ </th><th>í‰ê°€ê¸ˆì•¡</th><th>EMA200</th><th>RSI</th><th>DCF</th><th></th>
                    </tr></thead>
                    <tbody id="dash-tbody"><tr><td colspan="11" class="empty">Loading...</td></tr></tbody>
                </table>
            </div>
        </div>
        <div>
            <!-- Regime Score Card -->
            <div class="card" id="regime-card">
                <div class="card-title"><span>ğŸŒ Regime Score</span></div>
                <div class="gauge-wrap">
                    <div class="gauge-score" id="regime-score-val" style="color:var(--sub)">-</div>
                    <div class="gauge-label" style="margin-top:4px">/ 100ì </div>
                    <div id="regime-status-badge" style="margin-top:8px"></div>
                </div>
                <div id="regime-components" style="margin-top:16px"></div>
            </div>
            <!-- Balance -->
            <div class="card mt" id="balance-card">
                <div class="card-title"><span>ğŸ’° ì”ê³ </span>
                    <button class="btn btn-outline btn-sm" onclick="fetchBalance()">ì¡°íšŒ</button>
                </div>
                <div id="balance-content" style="color:var(--sub);font-size:0.88rem">ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¡°íšŒ</div>
            </div>
            <!-- Sector Mini Card -->
            <div class="card mt" id="sector-mini-card">
                <div class="card-title" style="margin-bottom:10px"><span>ğŸ—ï¸ ì„¹í„° ë¹„ì¤‘</span></div>
                <div id="sector-mini-content"><div class="empty" style="font-size:.8rem;padding:10px 0">-</div></div>
            </div>
        </div>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     2. PORTFOLIO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="portfolio" class="page-section">
    <div class="card" style="margin-bottom:16px">
        <div class="card-title">
            <span>ğŸ’¼ ë³´ìœ  ì¢…ëª©</span>
            <div style="display:flex;gap:8px">
                <input type="file" id="excelInput" accept=".xlsx,.xls" style="display:none" onchange="uploadExcel()">
                <button class="btn btn-outline btn-sm" onclick="document.getElementById('excelInput').click()">ğŸ“‚ Excel ì—…ë¡œë“œ</button>
                <button class="btn btn-outline btn-sm" onclick="syncPortfolio()">ğŸ”„ KIS ë™ê¸°í™”</button>
                <button class="btn btn-primary btn-sm" onclick="openTradeModal()">+ ë§¤ë§¤ ê¸°ë¡</button>
            </div>
        </div>
        <div class="tbl-wrap">
            <table>
                <thead><tr>
                    <th>ì¢…ëª©</th><th>ë§¤ìˆ˜ê°€</th><th>í˜„ì¬ê°€</th><th>ìˆ˜ëŸ‰</th>
                    <th>í‰ê°€ê¸ˆì•¡</th><th>ìˆ˜ìµë¥ </th><th>DCF ì ì •ê°€</th><th>RSI</th><th></th>
                </tr></thead>
                <tbody id="portfolio-tbody"><tr><td colspan="9" class="empty">Loading...</td></tr></tbody>
            </table>
        </div>
    </div>
    <!-- Sector Weights Card -->
    <div class="card" style="margin-bottom:16px">
        <div class="card-title">
            <span>ğŸ—ï¸ ì„¹í„° ë¹„ì¤‘ ê´€ë¦¬</span>
            <button class="btn btn-outline btn-sm" onclick="fetchSectorWeights()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
        </div>
        <div id="sector-weights-content"><div class="empty">Loading...</div></div>
    </div>

    <div class="card">
        <div class="card-title">
            <span>ğŸ“œ ë§¤ë§¤ ë‚´ì—­</span>
            <div style="display:flex;gap:8px;align-items:center">
                <select id="hist-market" style="width:90px;padding:5px 8px;font-size:0.82rem">
                    <option value="">ì „ì²´</option>
                    <option value="us">ë¯¸êµ­</option>
                    <option value="kr">í•œêµ­</option>
                </select>
                <input type="date" id="hist-date" style="width:140px;padding:5px 8px;font-size:0.82rem">
                <button class="btn btn-primary btn-sm" onclick="fetchHistory()">ì¡°íšŒ</button>
            </div>
        </div>
        <div class="tbl-wrap" style="max-height:400px;overflow-y:auto">
            <table>
                <thead><tr>
                    <th>ì¼ì‹œ</th><th>ì¢…ëª©</th><th>êµ¬ë¶„</th><th>ê°€ê²©</th>
                    <th>ìˆ˜ëŸ‰</th><th>ê¸ˆì•¡</th><th>ìˆ˜ìµë¥ </th>
                </tr></thead>
                <tbody id="history-tbody"><tr><td colspan="7" class="empty">ì¡°íšŒ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”</td></tr></tbody>
            </table>
        </div>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     3. MARKET WATCH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="market" class="page-section">
    <div class="grid-2" style="margin-bottom:16px">
        <div class="card">
            <div class="card-title">ğŸ“ˆ Top 20 ì‹¤ì‹œê°„
                <button class="btn btn-outline btn-sm" onclick="fetchTop20()">ğŸ”„</button>
            </div>
            <div class="tbl-wrap" style="max-height:500px;overflow-y:auto">
                <table>
                    <thead><tr><th>ì¢…ëª©</th><th>í˜„ì¬ê°€</th><th>ë“±ë½</th><th>RSI</th><th>ì‹ í˜¸</th></tr></thead>
                    <tbody id="top20-tbody"><tr><td colspan="5" class="empty">Loading...</td></tr></tbody>
                </table>
            </div>
        </div>
        <div class="card">
            <div class="card-title">âš¡ ë§¤ë§¤ ì‹ í˜¸</div>
            <div id="signals-content">
                <div class="section-title" style="margin-top:0">ê³¼ë§¤ë„ (RSI &lt; 30)</div>
                <div id="sig-oversold" class="empty">-</div>
                <div class="section-title mt">ê³¼ë§¤ìˆ˜ (RSI &gt; 70)</div>
                <div id="sig-overbought" class="empty">-</div>
                <div class="section-title mt">ì €í‰ê°€ (í˜„ê°€ &lt; DCFÃ—0.8)</div>
                <div id="sig-undervalued" class="empty">-</div>
                <div class="section-title mt">EMA200 ì§€ì§€</div>
                <div id="sig-ema200" class="empty">-</div>
            </div>
        </div>
    </div>
    <div class="card">
        <div class="card-title">ğŸ“° ë‰´ìŠ¤ ê²€ìƒ‰
        </div>
        <div style="display:flex;gap:10px;margin-bottom:14px">
            <input type="text" id="news-ticker" placeholder="í‹°ì»¤ ì…ë ¥ (ì˜ˆ: TSLA, ì‚¼ì„±ì „ì)" style="flex:1">
            <button class="btn btn-primary" onclick="searchNews()">ê²€ìƒ‰</button>
        </div>
        <div id="news-results" style="max-height:300px;overflow-y:auto;color:var(--sub);font-size:0.88rem">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</div>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     4. TRADING CONTROL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="trading" class="page-section">
    <div class="grid-2" style="margin-bottom:16px">
        <!-- Strategy Control -->
        <div class="card">
            <div class="card-title">âš™ï¸ ìë™ ë§¤ë§¤ ì œì–´</div>
            <div style="display:flex;flex-direction:column;gap:14px">
                <div style="background:#0f1115;border-radius:8px;padding:16px;text-align:center">
                    <div style="font-size:0.82rem;color:var(--sub);margin-bottom:8px">í˜„ì¬ ìƒíƒœ</div>
                    <div id="strategy-status-big" style="font-size:1.4rem;font-weight:700">í™•ì¸ ì¤‘...</div>
                </div>
                <div style="display:flex;gap:10px">
                    <button class="btn btn-success" style="flex:1;padding:12px" onclick="startStrategy()">â–¶ ì „ëµ ì‹œì‘</button>
                    <button class="btn btn-danger" style="flex:1;padding:12px" onclick="stopStrategy()">â¹ ì „ëµ ì¤‘ì§€</button>
                </div>
                <hr class="divider">
                <div class="card-title" style="margin-bottom:8px">ğŸ”¥ ìˆ˜ë™ ë§¤ë„</div>
                <div class="row">
                    <div class="col">
                        <label>í‹°ì»¤</label>
                        <input type="text" id="sell-ticker" placeholder="ì˜ˆ: AAPL">
                    </div>
                    <div class="col">
                        <label>ìˆ˜ëŸ‰ (0=ì „ëµ ìë™)</label>
                        <input type="number" id="sell-qty" value="0" min="0">
                    </div>
                </div>
                <button class="btn btn-danger" style="width:100%;margin-top:4px" onclick="executeSell()">ë§¤ë„ ì‹¤í–‰</button>
                <hr class="divider">
                <div>
                    <button class="btn btn-danger" style="width:100%;padding:12px" onclick="confirmSellAll()">
                        âš ï¸ ì „ëŸ‰ ë§¤ë„ í›„ ì „ëµ ì¬ë§¤ìˆ˜
                    </button>
                    <div style="font-size:0.75rem;color:var(--sub);margin-top:6px;text-align:center">ì£¼ì˜: ëª¨ë“  ë³´ìœ  ì¢…ëª©ì„ ë§¤ë„í•©ë‹ˆë‹¤</div>
                </div>
            </div>
        </div>

        <!-- Waiting List -->
        <div class="card">
            <div class="card-title">ğŸ“‹ ë§¤ë§¤ ëŒ€ê¸° ëª©ë¡
                <button class="btn btn-outline btn-sm" onclick="fetchWaitingList()">ğŸ”„</button>
            </div>
            <div id="waiting-list-content">
                <div class="section-title" style="margin-top:0">ë§¤ìˆ˜ ëŒ€ê¸°</div>
                <div id="wait-buy" class="empty">-</div>
                <div class="section-title mt">ë§¤ë„ ëŒ€ê¸°</div>
                <div id="wait-sell" class="empty">-</div>
            </div>
        </div>
    </div>

    <!-- Manual Order -->
    <div class="card">
        <div class="card-title">ğŸ“ ìˆ˜ë™ ì£¼ë¬¸</div>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;align-items:end">
            <div>
                <label>í‹°ì»¤</label>
                <input type="text" id="order-ticker" placeholder="ì˜ˆ: AAPL">
            </div>
            <div>
                <label>êµ¬ë¶„</label>
                <select id="order-type">
                    <option value="buy">ë§¤ìˆ˜ (BUY)</option>
                    <option value="sell">ë§¤ë„ (SELL)</option>
                </select>
            </div>
            <div>
                <label>ìˆ˜ëŸ‰</label>
                <input type="number" id="order-qty" value="1" min="1">
            </div>
            <div>
                <label>ê°€ê²© (0=ì‹œì¥ê°€)</label>
                <input type="number" id="order-price" value="0" step="0.01" min="0">
            </div>
        </div>
        <button class="btn btn-primary" style="margin-top:12px" onclick="placeOrder()">ì£¼ë¬¸ ì œì¶œ</button>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     5. MACRO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="macro" class="page-section">
    <div class="grid-2" style="margin-bottom:16px">
        <!-- Regime Score -->
        <div class="card">
            <div class="card-title">ğŸŒ ì‹œì¥ êµ­ë©´ (Regime Score)
                <button class="btn btn-outline btn-sm" onclick="fetchMacro()">ğŸ”„</button>
            </div>
            <div id="macro-regime-detail">
                <div class="empty">Loading...</div>
            </div>
        </div>
        <!-- Other Indicators -->
        <div class="card">
            <div class="card-title">ğŸ“Š ì£¼ìš” ì§€í‘œ</div>
            <div id="macro-indicators">
                <div class="empty">Loading...</div>
            </div>
        </div>
    </div>
    <div class="grid-2" style="margin-bottom:16px">
        <!-- Economic Indicators (FRED) -->
        <div class="card">
            <div class="card-title">ğŸ“ˆ FRED ê²½ì œ ì§€í‘œ (14ê°œ)</div>
            <div class="tbl-wrap" style="max-height:440px;overflow-y:auto">
                <table>
                    <thead><tr>
                        <th>ì§€í‘œ</th><th>ìµœì‹ ê°’</th><th>ì´ì „ê°’</th><th>ë³€í™”</th><th>ë°©í–¥</th><th>ê°€ì¤‘ì¹˜</th><th>íŒë‹¨</th>
                    </tr></thead>
                    <tbody id="econ-tbody"><tr><td colspan="7" class="empty">Loading...</td></tr></tbody>
                </table>
            </div>
        </div>
        <!-- Economic Calendar -->
        <div class="card">
            <div class="card-title">ğŸ“… ê²½ì œì§€í‘œ ë°œí‘œ ì¼ì • (7ì¼)
                <button class="btn btn-outline btn-sm" onclick="fetchEconCalendar()">ğŸ”„</button>
            </div>
            <div id="econ-calendar-content"><div class="empty">Loading...</div></div>
        </div>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     6. SETTINGS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="settings" class="page-section">
    <div class="grid-2" style="margin-bottom:16px">
        <!-- Strategy Settings -->
        <div class="card">
            <div class="card-title">âš™ï¸ ì „ëµ ì„¤ì •
                <button class="btn btn-outline btn-sm" onclick="fetchSettings()">ğŸ”„</button>
            </div>
            <div class="tbl-wrap" style="max-height:500px;overflow-y:auto">
                <table>
                    <thead><tr><th>ì„¤ì • í‚¤</th><th>í˜„ì¬ê°’</th><th>ìˆ˜ì •</th></tr></thead>
                    <tbody id="settings-tbody"><tr><td colspan="3" class="empty">Loading...</td></tr></tbody>
                </table>
            </div>
        </div>
        <!-- Price Alerts -->
        <div class="card">
            <div class="card-title">ğŸ”” ê°€ê²© ì•Œë¦¼</div>
            <div class="form-group">
                <label>í‹°ì»¤</label>
                <input type="text" id="alert-ticker" placeholder="ì˜ˆ: NVDA">
            </div>
            <div class="row" style="margin-bottom:12px">
                <div class="col">
                    <label>ì¡°ê±´</label>
                    <select id="alert-cond">
                        <option value="above">ì´ìƒ (â‰¥)</option>
                        <option value="below">ì´í•˜ (â‰¤)</option>
                    </select>
                </div>
                <div class="col">
                    <label>ëª©í‘œ ê°€ê²©</label>
                    <input type="number" id="alert-price" step="any" placeholder="0.00">
                </div>
            </div>
            <button class="btn btn-primary" style="width:100%;margin-bottom:16px" onclick="addAlert()">ì•Œë¦¼ ì„¤ì •</button>
            <div class="section-title">í™œì„± ì•Œë¦¼</div>
            <div id="alerts-list" style="color:var(--sub);font-size:0.88rem">Loading...</div>
        </div>
    </div>
    <!-- DCF Simulator -->
    <div class="card">
        <div class="card-title">ğŸ§¬ DCF ì‹œë®¬ë ˆì´í„°</div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:16px;align-items:end">
            <div>
                <label>í‹°ì»¤</label>
                <input type="text" id="dcf-ticker" placeholder="ì˜ˆ: AAPL">
            </div>
            <div>
                <label>1ë‹¨ê³„ ì„±ì¥ë¥ : <span id="dcf-growth-val">10</span>%</label>
                <input type="range" id="dcf-growth" min="-0.1" max="0.5" step="0.01" value="0.10" oninput="updateDcfLabel()">
            </div>
            <div>
                <label>í• ì¸ìœ¨ (WACC): <span id="dcf-discount-val">9.0</span>%</label>
                <input type="range" id="dcf-discount" min="0.04" max="0.20" step="0.005" value="0.09" oninput="updateDcfLabel()">
            </div>
            <div>
                <label>í„°ë¯¸ë„ ì„±ì¥: <span id="dcf-terminal-val">3.0</span>%</label>
                <input type="range" id="dcf-terminal" min="0" max="0.05" step="0.005" value="0.03" oninput="updateDcfLabel()">
            </div>
        </div>
        <button class="btn btn-primary" style="margin-top:12px" onclick="calcDcf()">ê³„ì‚°</button>
        <div id="dcf-result" style="margin-top:16px;padding:16px;background:#0f1115;border-radius:8px;text-align:center;display:none">
            <div style="color:var(--sub);font-size:0.82rem">DCF ì ì • ì£¼ê°€</div>
            <div id="dcf-result-val" style="font-size:2.5rem;font-weight:800;color:var(--accent);margin-top:4px">$0.00</div>
            <div id="dcf-result-note" style="color:var(--sub);font-size:0.82rem;margin-top:6px"></div>
        </div>
    </div>
</div>

</div><!-- /main-container -->

<!-- Trade Modal -->
<div id="tradeModal" class="modal-backdrop">
    <div class="modal-box">
        <div class="modal-title">ë§¤ë§¤ ê¸°ë¡ ì¶”ê°€</div>
        <div style="display:flex;gap:8px;margin-bottom:16px">
            <button id="btn-buy-mode" class="btn btn-success" style="flex:1" onclick="setTradeMode('buy')">BUY</button>
            <button id="btn-sell-mode" class="btn btn-outline" style="flex:1;color:var(--sub)" onclick="setTradeMode('sell')">SELL</button>
        </div>
        <div class="form-group">
            <label>í‹°ì»¤</label>
            <input type="text" id="tx-ticker" placeholder="ì˜ˆ: AAPL">
        </div>
        <div class="row" style="margin-bottom:16px">
            <div class="col">
                <label>ìˆ˜ëŸ‰</label>
                <input type="number" id="tx-qty" step="any" placeholder="0">
            </div>
            <div class="col">
                <label>ê°€ê²©</label>
                <input type="number" id="tx-price" step="any" placeholder="0.00">
            </div>
        </div>
        <div style="display:flex;justify-content:flex-end;gap:8px">
            <button class="btn btn-outline" onclick="closeTradeModal()">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="submitTrade()">í™•ì¸</button>
        </div>
    </div>
</div>

<!-- Setting Edit Modal -->
<div id="settingModal" class="modal-backdrop">
    <div class="modal-box">
        <div class="modal-title">ì„¤ì • ë³€ê²½</div>
        <input type="hidden" id="setting-key">
        <div class="form-group">
            <label id="setting-key-label">í‚¤</label>
            <input type="text" id="setting-val" placeholder="ìƒˆ ê°’ ì…ë ¥">
        </div>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
            <button class="btn btn-outline" onclick="closeModal('settingModal')">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="saveSetting()">ì €ì¥</button>
        </div>
    </div>
</div>

<script>
const API = '/api';
const USER = 'sean';
let tradeMode = 'buy';
let macroCache = null;

// â”€â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TOKEN_KEY = 'advisor_token';

function getToken() { return sessionStorage.getItem(TOKEN_KEY); }
function setToken(t) { sessionStorage.setItem(TOKEN_KEY, t); }
function clearToken() { sessionStorage.removeItem(TOKEN_KEY); }

function showLogin(msg='') {
    document.getElementById('login-overlay').classList.add('show');
    document.getElementById('login-error').textContent = msg;
    document.getElementById('login-id').value = '';
    document.getElementById('login-pw').value = '';
    setTimeout(() => document.getElementById('login-id').focus(), 100);
}
function hideLogin() {
    document.getElementById('login-overlay').classList.remove('show');
}

async function doLogin() {
    const id  = document.getElementById('login-id').value.trim();
    const pw  = document.getElementById('login-pw').value;
    const btn = document.getElementById('login-btn');
    if (!id || !pw) { document.getElementById('login-error').textContent = 'ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'; return; }
    btn.disabled = true; btn.textContent = 'ë¡œê·¸ì¸ ì¤‘...';
    try {
        const res = await fetch(API + '/auth/login', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({username: id, password: pw}),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'ë¡œê·¸ì¸ ì‹¤íŒ¨');
        setToken(data.access_token);
        hideLogin();
        initApp();
    } catch(e) {
        document.getElementById('login-error').textContent = e.message;
    } finally {
        btn.disabled = false; btn.textContent = 'ë¡œê·¸ì¸';
    }
}

function logout() {
    clearToken();
    showLogin();
}

// â”€â”€â”€ Tab Management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(el, tabId) {
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    el.classList.add('active');
    document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    const loaders = {
        dashboard: () => { fetchPortfolioFull(); fetchMacroBar(); fetchRegimeScore(); fetchSectorWeightsMini(); },
        portfolio:  () => { fetchPortfolioFull(true); fetchSectorWeights(); },
        market:    () => { fetchTop20(); fetchSignals(); },
        trading:   () => { fetchWaitingList(); fetchStrategyStatus(); },
        macro:     () => { fetchMacro(); fetchEconCalendar(); },
        settings:  () => { fetchSettings(); fetchAlerts(); },
    };
    loaders[tabId]?.();
}

// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const fmt = (v, d=2) => v == null ? '-' : Number(v).toFixed(d);
const fmtCurr = (v, sym='$') => v == null ? '-' : sym + Number(v).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
const fmtPct  = (v, sign=true) => v == null ? '-' : (sign && v > 0 ? '+' : '') + fmt(v) + '%';
const cls = (v) => v >= 0 ? 'up' : 'down';
const badge = (v) => v >= 0 ? '<span class="badge b-up">' + fmtPct(v) + '</span>' : '<span class="badge b-down">' + fmtPct(v) + '</span>';

async function apiFetch(path, opts={}) {
    const token = getToken();
    const headers = { ...(opts.headers || {}) };
    if (token) headers['Authorization'] = 'Bearer ' + token;
    const r = await fetch(API + path, { ...opts, headers });
    if (r.status === 401) {
        clearToken();
        showLogin('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.');
        throw new Error('unauthorized');
    }
    if (!r.ok) {
        const err = await r.json().catch(()=>({}));
        throw new Error(err.detail || r.statusText);
    }
    return r.json();
}

function showToast(msg, ok=true) {
    const t = document.createElement('div');
    t.textContent = msg;
    t.style.cssText = `position:fixed;bottom:24px;right:24px;padding:12px 20px;border-radius:8px;font-size:.9rem;font-weight:600;z-index:999;background:${ok?'#065f46':'#7f1d1d'};color:${ok?'#10b981':'#ef4444'};border:1px solid ${ok?'rgba(16,185,129,.4)':'rgba(239,68,68,.4)'}`;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 3000);
}

function setUpdated() {
    document.getElementById('last-updated').textContent = 'ê°±ì‹ : ' + new Date().toLocaleTimeString('ko-KR');
}

// â”€â”€â”€ Strategy Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchStrategyStatus() {
    try {
        const data = await apiFetch('/trading/waiting-list');
        const enabled = data?.enabled ?? data?.strategy_enabled ?? false;
        updateStrategyChip(enabled);
    } catch(e) {}
}

function updateStrategyChip(enabled) {
    const chip = document.getElementById('strategy-chip');
    const big  = document.getElementById('strategy-status-big');
    chip.textContent = enabled ? 'ì „ëµ ON' : 'ì „ëµ OFF';
    chip.className = 'status-chip ' + (enabled ? 'chip-on' : 'chip-off');
    if (big) {
        big.textContent = enabled ? 'â–¶ ì‹¤í–‰ ì¤‘' : 'â¹ ì¤‘ì§€ë¨';
        big.style.color = enabled ? 'var(--up)' : 'var(--down)';
    }
}

async function startStrategy() {
    try {
        await apiFetch('/trading/start');
        updateStrategyChip(true);
        showToast('âœ… ì „ëµì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤');
    } catch(e) { showToast('âŒ ' + e.message, false); }
}
async function stopStrategy() {
    try {
        await apiFetch('/trading/stop');
        updateStrategyChip(false);
        showToast('â¹ ì „ëµì´ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤');
    } catch(e) { showToast('âŒ ' + e.message, false); }
}

// â”€â”€â”€ Portfolio â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchPortfolioFull(portfolioTab=false) {
    try {
        const data = await apiFetch('/portfolio/' + USER + '/full-report');
        renderDashTable(data);
        if (portfolioTab) renderPortfolioTable(data);
        setUpdated();
    } catch(e) { console.error(e); }
}

async function syncPortfolio() {
    showToast('KIS ë™ê¸°í™” ì¤‘...');
    try {
        await apiFetch('/portfolio/' + USER, {method:'GET'});
        await fetchPortfolioFull();
        showToast('âœ… ë™ê¸°í™” ì™„ë£Œ');
    } catch(e) { showToast('âŒ ' + e.message, false); }
}

function renderDashTable(data) {
    const tbody = document.getElementById('dash-tbody');
    if (!data?.length) { tbody.innerHTML = '<tr><td colspan="11" class="empty">ë³´ìœ  ì¢…ëª© ì—†ìŒ</td></tr>'; return; }
    tbody.innerHTML = data.map(d => {
        const ret = d.return_pct ?? d.profit_pct;
        const rsi = d.rsi;
        const rsiCls = rsi < 30 ? 'b-up' : rsi > 70 ? 'b-down' : 'b-gray';
        const ema200 = d.ema200 ?? d.ema?.['200'];
        const price = d.price ?? d.current_price ?? 0;
        const changeRate = d.change_rate ?? d.change_pct ?? 0;
        return `<tr>
            <td><span class="ticker-cell">${d.ticker}</span><span class="sub-text">${d.name||''}</span></td>
            <td><b>${fmtCurr(price, d.market==='kr'?'â‚©':'$')}</b></td>
            <td class="${cls(changeRate)}">${fmtPct(changeRate)}</td>
            <td>${fmtCurr(d.buy_price??d.avg_price, d.market==='kr'?'â‚©':'$')}</td>
            <td>${fmt(d.quantity,0)}</td>
            <td>${badge(ret)}</td>
            <td>${fmtCurr(d.current_value, d.market==='kr'?'â‚©':'$')}</td>
            <td style="color:var(--sub);font-size:.8rem">${fmtCurr(ema200, d.market==='kr'?'â‚©':'$')}</td>
            <td><span class="badge ${rsiCls}">${fmt(rsi,1)}</span></td>
            <td style="font-size:.82rem">${d.dcf_fair ? fmtCurr(d.dcf_fair,'$') : '-'}</td>
            <td><button class="btn btn-outline btn-sm" onclick="openTradeFor('${d.ticker}')">ë§¤ë§¤</button></td>
        </tr>`;
    }).join('');
}

function renderPortfolioTable(data) {
    const tbody = document.getElementById('portfolio-tbody');
    if (!data?.length) { tbody.innerHTML = '<tr><td colspan="9" class="empty">ë³´ìœ  ì¢…ëª© ì—†ìŒ</td></tr>'; return; }
    tbody.innerHTML = data.map(d => {
        const ret = d.return_pct ?? d.profit_pct;
        const rsi = d.rsi;
        const rsiCls = rsi < 30 ? 'b-up' : rsi > 70 ? 'b-down' : 'b-gray';
        const sym = d.market === 'kr' ? 'â‚©' : '$';
        return `<tr>
            <td><span class="ticker-cell">${d.ticker}</span><span class="sub-text">${d.name||''}</span></td>
            <td>${fmtCurr(d.buy_price??d.avg_price, sym)}</td>
            <td>${fmtCurr(d.price??d.current_price, sym)}</td>
            <td>${fmt(d.quantity,0)}</td>
            <td>${fmtCurr(d.current_value, sym)}</td>
            <td>${badge(ret)}</td>
            <td style="font-size:.82rem">${d.dcf_fair ? fmtCurr(d.dcf_fair,'$') + '<span class="sub-text">' + fmtPct(d.dcf_upside) + '</span>' : '-'}</td>
            <td><span class="badge ${rsiCls}">${fmt(rsi,1)}</span></td>
            <td><button class="btn btn-outline btn-sm" style="color:var(--down);border-color:var(--down)" onclick="deleteHolding('${d.ticker}')">ì‚­ì œ</button></td>
        </tr>`;
    }).join('');
}

async function deleteHolding(ticker) {
    if (!confirm(`${ticker} ë³´ìœ  ì¢…ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
    try {
        await apiFetch('/portfolio/' + USER + '/' + ticker, {method:'DELETE'});
        showToast('âœ… ì‚­ì œë¨');
        fetchPortfolioFull(true);
    } catch(e) { showToast('âŒ ' + e.message, false); }
}

// â”€â”€â”€ Trade History â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchHistory() {
    const market = document.getElementById('hist-market').value;
    const date = document.getElementById('hist-date').value;
    let url = '/trading/history?limit=100';
    if (market) url += '&market=' + market;
    if (date)   url += '&date=' + date;
    try {
        const data = await apiFetch(url);
        const tbody = document.getElementById('history-tbody');
        if (!data?.length) { tbody.innerHTML = '<tr><td colspan="7" class="empty">ë‚´ì—­ ì—†ìŒ</td></tr>'; return; }
        tbody.innerHTML = data.map(d => {
            const isBuy = (d.action||d.order_type||'').toLowerCase() === 'buy';
            const retBadge = d.profit_pct != null ? badge(d.profit_pct) : '-';
            return `<tr>
                <td style="font-size:.8rem;white-space:nowrap">${(d.created_at||d.date||'').slice(0,16)}</td>
                <td><span class="ticker-cell">${d.ticker}</span><span class="sub-text">${d.name||''}</span></td>
                <td><span class="badge ${isBuy?'b-up':'b-down'}">${isBuy?'BUY':'SELL'}</span></td>
                <td>${fmtCurr(d.price, d.market==='kr'?'â‚©':'$')}</td>
                <td>${fmt(d.quantity,0)}</td>
                <td>${fmtCurr(d.amount??((d.price||0)*(d.quantity||0)), d.market==='kr'?'â‚©':'$')}</td>
                <td>${retBadge}</td>
            </tr>`;
        }).join('');
    } catch(e) { showToast('âŒ ' + e.message, false); }
}

// â”€â”€â”€ Balance â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchBalance() {
    const el = document.getElementById('balance-content');
    el.textContent = 'ì¡°íšŒ ì¤‘...';
    try {
        const data = await apiFetch('/trading/balance');
        const rows = [];
        if (data.total_eval) rows.push(['ì´ í‰ê°€ê¸ˆì•¡', fmtCurr(data.total_eval,'â‚©')]);
        if (data.cash_kr)    rows.push(['KR í˜„ê¸ˆ', fmtCurr(data.cash_kr,'â‚©')]);
        if (data.cash_us)    rows.push(['US í˜„ê¸ˆ', fmtCurr(data.cash_us,'$')]);
        if (data.profit_loss) rows.push(['ì†ìµ', fmtCurr(data.profit_loss,'â‚©')]);
        el.innerHTML = rows.length
            ? rows.map(r=>`<div style="display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid var(--border)"><span style="color:var(--sub)">${r[0]}</span><b>${r[1]}</b></div>`).join('')
            : `<pre style="font-size:.75rem;color:var(--sub);white-space:pre-wrap">${JSON.stringify(data,null,2)}</pre>`;
    } catch(e) { el.textContent = 'ì¡°íšŒ ì‹¤íŒ¨: ' + e.message; }
}

// â”€â”€â”€ Sector Weights â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SECTOR_LABELS = { tech: 'ê¸°ìˆ ì£¼', value: 'ê°€ì¹˜ì£¼', financial: 'ê¸ˆìœµì£¼' };
const SECTOR_ICONS  = { tech: 'ğŸ’»', value: 'ğŸ¥', financial: 'ğŸ¦' };

async function fetchSectorWeights() {
    const el = document.getElementById('sector-weights-content');
    if (el) el.innerHTML = '<div class="empty">Loading...</div>';
    try {
        const data = await apiFetch('/analysis/sector-weights?user_id=' + USER);
        if (el) el.innerHTML = renderSectorWeightsFull(data);
        // ë¯¸ë‹ˆ ì¹´ë“œë„ ê°™ì´ ì—…ë°ì´íŠ¸
        renderSectorMini(data);
    } catch(e) {
        if (el) el.innerHTML = `<div class="empty" style="color:var(--down)">ì˜¤ë¥˜: ${e.message}</div>`;
    }
}

async function fetchSectorWeightsMini() {
    try {
        const data = await apiFetch('/analysis/sector-weights?user_id=' + USER);
        renderSectorMini(data);
    } catch(e) {}
}

function renderSectorMini(data) {
    const el = document.getElementById('sector-mini-content');
    if (!el) return;
    const weights = data?.weights || {};
    const groups = ['tech', 'value', 'financial'];
    el.innerHTML = groups.map(g => {
        const w = weights[g] || {};
        const cur = (w.weight ?? w.current ?? 0) * 100;
        const tgt = (w.target ?? 0) * 100;
        const dev = (w.dev ?? 0) * 100;
        const barColor = Math.abs(dev) < 5 ? 'var(--up)' : dev > 0 ? 'var(--down)' : 'var(--warn)';
        const tgtPct = Math.min(tgt, 100);
        return `<div style="margin-bottom:8px">
            <div style="display:flex;justify-content:space-between;font-size:.78rem;margin-bottom:2px">
                <span>${SECTOR_ICONS[g]} ${SECTOR_LABELS[g]}</span>
                <span style="color:${barColor};font-weight:700">${cur.toFixed(1)}% <span style="color:var(--sub);font-weight:400">(ëª©í‘œ ${tgt.toFixed(0)}%)</span></span>
            </div>
            <div class="sector-mini-bar">
                <div class="sector-mini-fill" style="width:${Math.min(cur,100)}%;background:${barColor}"></div>
                <div style="position:absolute;top:0;left:${tgtPct}%;width:2px;height:100%;background:rgba(255,255,255,.4)"></div>
            </div>
        </div>`;
    }).join('');
}

function renderSectorWeightsFull(data) {
    const weights = data?.weights || {};
    const underweight = data?.underweight || [];
    const overweight  = data?.overweight  || [];
    const groups = ['tech', 'value', 'financial'];

    const weightRows = groups.map(g => {
        const w = weights[g] || {};
        const cur = (w.weight ?? w.current ?? 0) * 100;
        const tgt = (w.target ?? 0) * 100;
        const dev = (w.dev ?? 0) * 100;
        const devAbs = Math.abs(dev);
        const isOk = devAbs < 5;
        const isOver = dev > 5;
        const isUnder = dev < -5;
        const barColor = isOk ? 'var(--up)' : isOver ? 'var(--down)' : 'var(--warn)';
        const devBadge = isOk
            ? `<span class="badge b-up">ì ì •</span>`
            : isOver
                ? `<span class="badge b-down">+${dev.toFixed(1)}% ì´ˆê³¼</span>`
                : `<span class="badge b-warn">${dev.toFixed(1)}% ë¶€ì¡±</span>`;
        const tgtPct = Math.min(tgt, 100);
        return `<div class="sector-row">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                <div>
                    <span style="font-weight:700;font-size:.95rem">${SECTOR_ICONS[g]} ${SECTOR_LABELS[g]}</span>
                    <span style="color:var(--sub);font-size:.78rem;margin-left:8px">ëª©í‘œ ${tgt.toFixed(0)}%</span>
                </div>
                <div style="display:flex;align-items:center;gap:10px">
                    ${devBadge}
                    <span style="font-size:1rem;font-weight:800;color:${barColor}">${cur.toFixed(1)}%</span>
                </div>
            </div>
            <div class="sector-bar-outer">
                <div class="sector-bar-fill2" style="width:${Math.min(cur,100)}%;background:${barColor}"></div>
                <div class="sector-target-line" style="left:${tgtPct}%"></div>
            </div>
        </div>`;
    }).join('');

    const renderHoldingList = (list) => list.length
        ? list.map(h => `<span style="display:inline-block;padding:2px 8px;background:#252a33;border-radius:4px;font-size:.8rem;margin:2px">${h.ticker ?? h}</span>`).join('')
        : '<span style="color:var(--sub);font-size:.82rem">ì—†ìŒ</span>';

    const totalKrw = data?.total_stock_krw;
    const totalLabel = totalKrw ? `ì´ ì£¼ì‹ í‰ê°€ì•¡: â‚©${Math.round(totalKrw).toLocaleString()}` : '';

    return `
        ${totalLabel ? `<div style="font-size:.8rem;color:var(--sub);margin-bottom:12px">${totalLabel}</div>` : ''}
        ${weightRows}
        <div style="margin-top:14px;display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div>
                <div class="section-title" style="margin-bottom:6px">ğŸ“ˆ ë§¤ìˆ˜ ìš°ì„  (ë¶€ì¡± ì„¹í„°)</div>
                <div>${renderHoldingList(underweight)}</div>
            </div>
            <div>
                <div class="section-title" style="margin-bottom:6px">ğŸ“‰ ë§¤ë„ ê³ ë ¤ (ì´ˆê³¼ ì„¹í„°)</div>
                <div>${renderHoldingList(overweight)}</div>
            </div>
        </div>`;
}

// â”€â”€â”€ Economic Calendar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchEconCalendar() {
    const el = document.getElementById('econ-calendar-content');
    if (el) el.innerHTML = '<div class="empty">Loading...</div>';
    try {
        const data = await apiFetch('/market/calendar/weekly?days=7');
        if (!el) return;
        if (!data?.length) { el.innerHTML = '<div class="empty">ì´ë²ˆ ì£¼ ì˜ˆì • ì—†ìŒ</div>'; return; }
        el.innerHTML = data.map(ev => {
            const isPast = ev.is_past;
            const opacity = isPast ? 'opacity:.5' : '';
            const datePart = ev.date_kst || ev.date;
            const timeKst  = ev.time_kst || '-';
            const names    = (ev.names || []).join(', ');
            const weight   = ev.total_weight;
            const weightColor = weight >= 6 ? 'var(--down)' : weight >= 3 ? 'var(--warn)' : 'var(--sub)';
            return `<div style="padding:10px 0;border-bottom:1px solid var(--border);${opacity}">
                <div style="display:flex;justify-content:space-between;align-items:flex-start">
                    <div>
                        <div style="font-size:.82rem;font-weight:600">${names}</div>
                        <div style="font-size:.73rem;color:var(--sub);margin-top:2px">${datePart} ${timeKst} KST</div>
                    </div>
                    <div style="display:flex;align-items:center;gap:6px">
                        <span style="font-size:.72rem;font-weight:700;color:${weightColor}">ì¤‘ìš”ë„ ${weight}</span>
                        ${isPast?'<span class="badge b-gray">ì™„ë£Œ</span>':'<span class="badge b-up">ì˜ˆì •</span>'}
                    </div>
                </div>
            </div>`;
        }).join('');
    } catch(e) {
        if (el) el.innerHTML = `<div class="empty" style="color:var(--down)">ì˜¤ë¥˜: ${e.message}</div>`;
    }
}

// â”€â”€â”€ Macro Bar & Regime â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchMacroBar() {
    try {
        const data = await apiFetch('/market/macro');
        macroCache = data;
        renderMacroBar(data);
        renderRegimeScore(data.market_regime);
    } catch(e) { console.error(e); }
}

async function fetchRegimeScore() {
    if (macroCache) { renderRegimeScore(macroCache.market_regime); return; }
    await fetchMacroBar();
}

function renderMacroBar(data) {
    const r = data.market_regime || {};
    const vix = data.vix;
    const yield10y = data.us_10y_yield;
    const btc = (data.crypto||{}).BTC;
    const gold = (data.commodities||{}).Gold;
    const oil  = (data.commodities||{}).Oil;
    const fg = data.fear_greed;

    const chips = [
        { label:'Regime', val: (r.status||'-') + ' ' + (r.regime_score!=null?r.regime_score+'ì ':''), cls: r.status==='Bull'?'up':r.status==='Bear'?'down':'' },
        { label:'SPX vs MA200', val: fmtPct(r.diff_pct,true), cls: cls(r.diff_pct||0) },
        { label:'US 10Y', val: yield10y ? yield10y + '%' : '-', cls:'' },
        { label:'VIX', val: vix ?? '-', cls: vix>25?'down':vix<15?'up':'' },
        { label:'Fear&Greed', val: fg!=null ? fg + '/100' : '-', cls: fg>60?'up':fg<40?'down':'' },
        { label:'BTC', val: btc?.price ? '$'+Number(btc.price).toLocaleString() : '-', sub: btc?.change!=null?fmtPct(btc.change,true):null, cls: cls(btc?.change||0) },
        { label:'Gold', val: gold?.price ? '$'+fmt(gold.price) : '-', sub: gold?.change!=null?fmtPct(gold.change,true):null, cls: cls(gold?.change||0) },
        { label:'Oil (WTI)', val: oil?.price ? '$'+fmt(oil.price) : '-', sub: oil?.change!=null?fmtPct(oil.change,true):null, cls: cls(oil?.change||0) },
    ];

    document.getElementById('macro-bar').innerHTML = chips.map(c => `
        <div class="macro-chip">
            <div class="mc-label">${c.label}</div>
            <div class="mc-val ${c.cls}">${c.val}</div>
            ${c.sub ? `<div class="mc-sub ${c.cls}">${c.sub}</div>` : ''}
        </div>`).join('');
}

function renderRegimeScore(r) {
    if (!r) return;
    const score = r.regime_score ?? 50;
    const status = r.status ?? 'Neutral';
    const comp = r.components || {};
    const color = status==='Bull' ? 'var(--up)' : status==='Bear' ? 'var(--down)' : 'var(--warn)';
    const od = comp.other_detail || {};
    const td = comp.technical_detail || {};

    document.getElementById('regime-score-val').textContent = score;
    document.getElementById('regime-score-val').style.color = color;
    document.getElementById('regime-status-badge').innerHTML =
        `<span class="badge ${status==='Bull'?'b-up':status==='Bear'?'b-down':'b-warn'}" style="font-size:.85rem;padding:5px 12px">${status}</span>`;

    // Bear threshold badge
    const bearThr = r.bear_threshold ?? 40;
    const bearThrColor = bearThr >= 48 ? 'var(--down)' : bearThr >= 44 ? 'var(--warn)' : 'var(--sub)';
    const bearPersistLabel = bearThr >= 48 ? '2ê°œì›” ì—°ì† Bear' : bearThr >= 44 ? '1ê°œì›” ì „ Bear' : 'ì •ìƒ';

    const techDetails = [
        td.spx_1m_ret!=null ? `1M ${fmtPct(td.spx_1m_ret)}` : '',
        td.spx_2w_ret!=null ? `2W ${fmtPct(td.spx_2w_ret)}` : '',
        td.spx_from_ath!=null ? `ATHëŒ€ë¹„ ${fmtPct(td.spx_from_ath)}` : '',
    ].filter(Boolean).join(' | ');

    const items = [
        { name:'ê¸°ìˆ  (EMA)', key:'technical', detail: techDetails },
        { name:'VIX',        key:'vix',       detail: od.vix_1m_chg!=null?`1M ${fmtPct(od.vix_1m_chg)}`:'' },
        { name:'Fear&Greed', key:'fear_greed',detail:'' },
        { name:'ê²½ì œì§€í‘œ',   key:'economic',  detail:'' },
        { name:'ê¸°íƒ€ (ê¸ˆë¦¬Â·BTCÂ·DXYÂ·Gold)', key:'other',
          detail: [
            od.us_10y_yield!=null?`10Y ${od.us_10y_yield}%`:'',
            od.yield_spread_10y2y!=null?`ìŠ¤í”„ë ˆë“œ ${fmtPct(od.yield_spread_10y2y)}` : '',
            od.btc_1m_ret!=null?`BTC ${fmtPct(od.btc_1m_ret)}`:'',
            od.dxy_1m_ret!=null?`DXY ${fmtPct(od.dxy_1m_ret)}`:'',
            od.gold_1m_ret!=null?`Gold ${fmtPct(od.gold_1m_ret)}`:'',
          ].filter(Boolean).join(' | ') },
    ];

    document.getElementById('regime-components').innerHTML = items.map(item => {
        const val = comp[item.key] ?? 10;
        const pct = val / 20 * 100;
        const barColor = val >= 14 ? 'var(--up)' : val <= 7 ? 'var(--down)' : 'var(--warn)';
        return `<div class="score-row">
            <div>
                <div style="font-size:.85rem;font-weight:600">${item.name}</div>
                ${item.detail?`<div style="font-size:.72rem;color:var(--sub)">${item.detail}</div>`:''}
            </div>
            <div style="display:flex;align-items:center;gap:10px">
                <div class="score-bar-wrap"><div class="score-bar-fill" style="width:${pct}%;background:${barColor}"></div></div>
                <span style="font-size:.88rem;font-weight:700;min-width:28px;text-align:right;color:${barColor}">${val}</span>
                <span style="font-size:.72rem;color:var(--sub)">/20</span>
            </div>
        </div>`;
    }).join('') + `<div style="margin-top:10px;padding:8px;background:#0f1115;border-radius:6px;display:flex;justify-content:space-between;align-items:center">
        <span style="font-size:.75rem;color:var(--sub)">Bear ì„ê³„ê°’</span>
        <span style="font-size:.8rem;font-weight:700;color:${bearThrColor}">${bearThr}ì  (${bearPersistLabel})</span>
    </div>`;
}

// â”€â”€â”€ Macro Tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchMacro() {
    try {
        const data = await apiFetch('/market/macro');
        macroCache = data;
        renderMacroDetail(data);
        renderEconTable(data.economic_indicators);
    } catch(e) { console.error(e); }
}

function renderMacroDetail(data) {
    const r = data.market_regime || {};
    const comp = r.components || {};
    const od = comp.other_detail || {};
    const score = r.regime_score ?? 50;
    const status = r.status ?? 'Neutral';
    const color = status==='Bull'?'var(--up)':status==='Bear'?'var(--down)':'var(--warn)';

    const td2 = comp.technical_detail || {};
    const bearThr2 = r.bear_threshold ?? 40;
    const bearThrColor2 = bearThr2 >= 48 ? 'var(--down)' : bearThr2 >= 44 ? 'var(--warn)' : 'var(--sub)';
    const bearPersistLabel2 = bearThr2 >= 48 ? '2ê°œì›” ì—°ì† Bear' : bearThr2 >= 44 ? '1ê°œì›” ì „ Bear' : 'ì •ìƒ';

    document.getElementById('macro-regime-detail').innerHTML = `
        <div style="text-align:center;padding:12px 0">
            <div style="font-size:3rem;font-weight:800;color:${color}">${score}</div>
            <div style="font-size:1rem;color:var(--sub)">/ 100ì  &nbsp;|&nbsp; Bear ì„ê³„ê°’: <b style="color:${bearThrColor2}">${bearThr2}</b></div>
            <span class="badge ${status==='Bull'?'b-up':status==='Bear'?'b-down':'b-warn'}" style="font-size:.88rem;padding:5px 14px;margin-top:8px;display:inline-block">${status}</span>
            ${bearThr2>40?`<div style="font-size:.73rem;color:${bearThrColor2};margin-top:5px">âš ï¸ Bear ì§€ì†ì„± ì ìš©: ${bearPersistLabel2}</div>`:''}
        </div>
        <hr class="divider">
        <div style="font-size:.82rem;color:var(--sub);margin-bottom:8px">êµ¬ì„± ìš”ì†Œ (ê° 0~20ì )</div>
        ${['technical','vix','fear_greed','economic','other'].map(k => {
            const v = comp[k] ?? 10;
            const barColor = v>=14?'var(--up)':v<=7?'var(--down)':'var(--warn)';
            const names = {technical:'ê¸°ìˆ  EMA', vix:'VIX', fear_greed:'Fear&Greed', economic:'ê²½ì œì§€í‘œ', other:'ê¸°íƒ€'};
            const subDetail = k==='technical' ? [
                td2.spx_1m_ret!=null?`1M ${fmtPct(td2.spx_1m_ret)}`:'',
                td2.spx_2w_ret!=null?`2W ${fmtPct(td2.spx_2w_ret)}`:'',
                td2.spx_from_ath!=null?`ATHëŒ€ë¹„ ${fmtPct(td2.spx_from_ath)}`:'',
            ].filter(Boolean).join(' | ') : '';
            return `<div style="padding:6px 0">
                <div style="display:flex;justify-content:space-between;align-items:center">
                    <span style="font-size:.85rem">${names[k]}</span>
                    <div style="display:flex;align-items:center;gap:8px">
                        <div style="width:80px;height:6px;background:#252a33;border-radius:3px">
                            <div style="width:${v/20*100}%;height:100%;border-radius:3px;background:${barColor}"></div>
                        </div>
                        <b style="color:${barColor};min-width:20px;text-align:right">${v}</b>
                    </div>
                </div>
                ${subDetail?`<div style="font-size:.7rem;color:var(--sub);margin-top:2px">${subDetail}</div>`:''}
            </div>`;
        }).join('')}
        <hr class="divider">
        <div style="font-size:.82rem">
            ${od.us_10y_yield!=null?`<div class="score-row"><span style="color:var(--sub)">10Y ê¸ˆë¦¬</span><b>${od.us_10y_yield}%</b></div>`:''}
            ${od.yield_spread_10y2y!=null?`<div class="score-row"><span style="color:var(--sub)">10Y-2Y ìŠ¤í”„ë ˆë“œ</span><b class="${cls(od.yield_spread_10y2y)}">${fmtPct(od.yield_spread_10y2y)}</b></div>`:''}
            ${od.vix_1m_chg!=null?`<div class="score-row"><span style="color:var(--sub)">VIX 1ê°œì›” ë³€í™”</span><b class="${cls(-od.vix_1m_chg)}">${fmtPct(od.vix_1m_chg)}</b></div>`:''}
            ${od.btc_1m_ret!=null?`<div class="score-row"><span style="color:var(--sub)">BTC 1ê°œì›”</span><b class="${cls(od.btc_1m_ret)}">${fmtPct(od.btc_1m_ret)}</b></div>`:''}
            ${od.dxy_1m_ret!=null?`<div class="score-row"><span style="color:var(--sub)">DXY 1ê°œì›”</span><b class="${cls(-od.dxy_1m_ret)}">${fmtPct(od.dxy_1m_ret)}</b></div>`:''}
            ${od.gold_1m_ret!=null?`<div class="score-row"><span style="color:var(--sub)">Gold 1ê°œì›”</span><b class="${cls(-od.gold_1m_ret)}">${fmtPct(od.gold_1m_ret)}</b></div>`:''}
        </div>`;

    document.getElementById('macro-indicators').innerHTML = `
        <div class="score-row"><span style="color:var(--sub)">SPX í˜„ì¬ê°€</span><b>$${r.current?.toLocaleString()??'-'}</b></div>
        <div class="score-row"><span style="color:var(--sub)">SPX MA200</span><b>$${r.ma200?.toLocaleString()??'-'}</b></div>
        <div class="score-row"><span style="color:var(--sub)">MA200 ëŒ€ë¹„</span><b class="${cls(r.diff_pct||0)}">${fmtPct(r.diff_pct)}</b></div>
        <div class="score-row"><span style="color:var(--sub)">VIX</span><b class="${(data.vix||0)>25?'down':(data.vix||0)<15?'up':''}">${data.vix??'-'}</b></div>
        <div class="score-row"><span style="color:var(--sub)">Fear&Greed</span><b>${data.fear_greed??'-'}/100</b></div>
        <div class="score-row"><span style="color:var(--sub)">US 10Y ê¸ˆë¦¬</span><b>${data.us_10y_yield??'-'}%</b></div>
        ${['BTC','Gold','Oil'].map(k => {
            const item = k==='BTC'?(data.crypto||{}).BTC:(data.commodities||{})[k];
            if (!item) return '';
            const sym = k==='BTC'?'$':'$';
            return `<div class="score-row"><span style="color:var(--sub)">${k}</span><b>${fmtCurr(item.price,sym)} <span class="${cls(item.change||0)}" style="font-size:.8rem">${fmtPct(item.change)}</span></b></div>`;
        }).join('')}
        ${Object.entries(data.indices||{}).map(([name,info]) =>
            `<div class="score-row"><span style="color:var(--sub)">${name}</span><b>${info.price?.toLocaleString()??'-'} <span class="${cls(info.change||0)}" style="font-size:.8rem">${fmtPct(info.change)}</span></b></div>`
        ).join('')}`;
}

function renderEconTable(econ) {
    const tbody = document.getElementById('econ-tbody');
    const inds = econ?.indicators;
    if (!inds) { tbody.innerHTML = '<tr><td colspan="7" class="empty">ë°ì´í„° ì—†ìŒ</td></tr>'; return; }
    tbody.innerHTML = Object.entries(inds).map(([k,v]) => {
        const delta = v.delta;
        const statusCls = v.status==='positive'?'b-up':v.status==='negative'?'b-down':'b-gray';
        const statusTxt = v.status==='positive'?'ê¸ì •':'negative'===v.status?'ë¶€ì •':'ì¤‘ë¦½';
        return `<tr>
            <td><b>${v.name}</b><span class="sub-text">${v.series_id}</span></td>
            <td>${v.latest??'-'}</td>
            <td>${v.previous??'-'}</td>
            <td class="${delta!=null?cls(delta):''}">${delta!=null?fmtPct(delta/Math.abs(v.previous||1)*100,true):'-'}</td>
            <td><span class="badge ${delta!=null?(delta>0?'b-up':'b-down'):'b-gray'}">${delta!=null?(delta>0?'â–²':'â–¼'):'-'}</span></td>
            <td style="color:var(--sub)">${v.weight}</td>
            <td><span class="badge ${statusCls}">${statusTxt}</span></td>
        </tr>`;
    }).join('');
}

// â”€â”€â”€ Market Watch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchTop20() {
    try {
        const data = await apiFetch('/market/top20');
        const tbody = document.getElementById('top20-tbody');
        const entries = Object.entries(data).filter(([k]) => !k.startsWith('message'));
        if (!entries.length) { tbody.innerHTML = '<tr><td colspan="5" class="empty">ìˆ˜ì§‘ ì¤‘...</td></tr>'; return; }
        tbody.innerHTML = entries.map(([ticker, info]) => {
            const rsi = info.rsi;
            const rsiCls = rsi < 30 ? 'b-up' : rsi > 70 ? 'b-down' : 'b-gray';
            const sig = rsi < 30 ? '<span class="badge b-up">BUY</span>' : rsi > 70 ? '<span class="badge b-down">SELL</span>' : '-';
            return `<tr>
                <td class="ticker-cell">${ticker}</td>
                <td>$${fmt(info.price)}</td>
                <td class="${cls(info.change_rate||0)}">${fmtPct(info.change_rate)}</td>
                <td><span class="badge ${rsiCls}">${fmt(rsi,1)}</span></td>
                <td>${sig}</td>
            </tr>`;
        }).join('');
    } catch(e) { console.error(e); }
}

async function fetchSignals() {
    try {
        const data = await apiFetch('/market/signals');
        const render = (items, fields) => items?.length
            ? items.map(i => `<div style="padding:5px 0;border-bottom:1px solid var(--border);font-size:.85rem">
                <b>${i.ticker}</b> â€” ${fields.map(f=>`${f}: ${i[f]??'-'}`).join(' | ')}
              </div>`).join('')
            : '<div class="empty">ì—†ìŒ</div>';
        document.getElementById('sig-oversold').innerHTML   = render(data.oversold,   ['rsi','price']);
        document.getElementById('sig-overbought').innerHTML = render(data.overbought,  ['rsi','price']);
        document.getElementById('sig-undervalued').innerHTML= render(data.undervalued, ['price','dcf','upside_pct']);
        document.getElementById('sig-ema200').innerHTML     = render(data.ema200_support, ['price','ema200']);
    } catch(e) { console.error(e); }
}

async function searchNews() {
    const ticker = document.getElementById('news-ticker').value.trim();
    if (!ticker) return;
    const el = document.getElementById('news-results');
    el.innerHTML = 'ê²€ìƒ‰ ì¤‘...';
    try {
        const data = await apiFetch('/market/news/' + encodeURIComponent(ticker));
        if (!data?.length) { el.innerHTML = 'ê²°ê³¼ ì—†ìŒ'; return; }
        el.innerHTML = data.map(n => `
            <div style="padding:10px 0;border-bottom:1px solid var(--border)">
                <a href="${n.link||n.url||'#'}" target="_blank" style="color:var(--accent);text-decoration:none;font-weight:500;font-size:.9rem">${n.title}</a>
                <div style="font-size:.75rem;color:var(--sub);margin-top:3px">${n.publisher||n.source||'-'} Â· ${(n.date||n.published_at||'').slice(0,10)}</div>
            </div>`).join('');
    } catch(e) { el.innerHTML = 'ì˜¤ë¥˜: ' + e.message; }
}

// â”€â”€â”€ Trading Control â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchWaitingList() {
    try {
        const data = await apiFetch('/trading/waiting-list');
        const enabled = data?.enabled ?? data?.strategy_enabled ?? null;
        if (enabled !== null) updateStrategyChip(enabled);

        const renderList = (items) => items?.length
            ? items.map(i => `<div style="padding:5px 0;border-bottom:1px solid var(--border);font-size:.85rem">
                <b>${i.ticker}</b> â€” ${i.reason||i.signal||''} <span style="color:var(--sub)">${i.score!=null?'ì ìˆ˜:'+i.score:''}</span>
              </div>`).join('')
            : '<div class="empty">ì—†ìŒ</div>';
        document.getElementById('wait-buy').innerHTML  = renderList(data?.buy_list  ?? data?.buy);
        document.getElementById('wait-sell').innerHTML = renderList(data?.sell_list ?? data?.sell);
    } catch(e) { console.error(e); }
}

async function executeSell() {
    const ticker = document.getElementById('sell-ticker').value.trim();
    const qty    = parseInt(document.getElementById('sell-qty').value) || 0;
    if (!ticker) { showToast('í‹°ì»¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”', false); return; }
    if (!confirm(`${ticker} ${qty||'ì „ëµ ìë™'}ì£¼ ë§¤ë„í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
    try {
        await apiFetch('/trading/sell', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ticker, quantity: qty}),
        });
        showToast('âœ… ë§¤ë„ ì™„ë£Œ');
    } catch(e) { showToast('âŒ ' + e.message, false); }
}

async function placeOrder() {
    const ticker = document.getElementById('order-ticker').value.trim();
    const qty    = parseInt(document.getElementById('order-qty').value);
    const price  = parseFloat(document.getElementById('order-price').value);
    const type   = document.getElementById('order-type').value;
    if (!ticker || !qty) { showToast('í‹°ì»¤ì™€ ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”', false); return; }
    if (!confirm(`${ticker} ${qty}ì£¼ ${type.toUpperCase()} (${price||'ì‹œì¥ê°€'}) ì£¼ë¬¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
    try {
        await apiFetch('/trading/order', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ticker, quantity: qty, price, order_type: type}),
        });
        showToast('âœ… ì£¼ë¬¸ ì™„ë£Œ');
    } catch(e) { showToast('âŒ ' + e.message, false); }
}

async function confirmSellAll() {
    if (!confirm('âš ï¸ ëª¨ë“  ë³´ìœ  ì¢…ëª©ì„ ì „ëŸ‰ ë§¤ë„í•˜ê³  ì „ëµì— ë”°ë¼ ì¬ë§¤ìˆ˜í•©ë‹ˆë‹¤.\nì •ë§ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    if (!confirm('ìµœì¢… í™•ì¸: ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
    try {
        showToast('ì‹¤í–‰ ì¤‘...');
        const data = await apiFetch('/trading/sell-all-and-rebuy', {method:'POST'});
        showToast(`âœ… ${data.message||'ì™„ë£Œ'}`);
    } catch(e) { showToast('âŒ ' + e.message, false); }
}

// â”€â”€â”€ Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchSettings() {
    try {
        const data = await apiFetch('/trading/settings');
        const tbody = document.getElementById('settings-tbody');
        tbody.innerHTML = data.map(s => `<tr>
            <td style="font-size:.82rem;font-weight:600">${s.key}</td>
            <td style="font-size:.85rem">${s.value ?? s.val ?? '-'}</td>
            <td><button class="btn btn-outline btn-sm" onclick="openSettingEdit('${s.key}','${s.value??s.val??''}')">ìˆ˜ì •</button></td>
        </tr>`).join('');
    } catch(e) { console.error(e); }
}

function openSettingEdit(key, val) {
    document.getElementById('setting-key').value = key;
    document.getElementById('setting-key-label').textContent = key;
    document.getElementById('setting-val').value = val;
    openModal('settingModal');
}

async function saveSetting() {
    const key = document.getElementById('setting-key').value;
    const val = document.getElementById('setting-val').value;
    try {
        await apiFetch('/trading/settings', {
            method:'PUT',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({key, value: val}),
        });
        showToast('âœ… ì €ì¥ë¨');
        closeModal('settingModal');
        fetchSettings();
    } catch(e) { showToast('âŒ ' + e.message, false); }
}

// â”€â”€â”€ Alerts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchAlerts() {
    try {
        const data = await apiFetch('/alerts/pending');
        const el = document.getElementById('alerts-list');
        const alerts = data?.alerts ?? data?.pending ?? [];
        el.innerHTML = alerts.length
            ? alerts.map(a => `<div style="padding:8px;background:#252a33;border-radius:6px;margin-bottom:6px;font-size:.85rem">
                <b>${a.ticker}</b> â€” ${a.condition} $${a.price}
              </div>`).join('')
            : '<div style="color:var(--sub)">í™œì„± ì•Œë¦¼ ì—†ìŒ</div>';
    } catch(e) { console.error(e); }
}

async function addAlert() {
    const ticker = document.getElementById('alert-ticker').value.trim();
    const cond   = document.getElementById('alert-cond').value;
    const price  = parseFloat(document.getElementById('alert-price').value);
    if (!ticker || !price) { showToast('í‹°ì»¤ì™€ ê°€ê²©ì„ ì…ë ¥í•˜ì„¸ìš”', false); return; }
    try {
        await apiFetch('/alerts', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ticker, condition: cond, price}),
        });
        showToast('âœ… ì•Œë¦¼ ì„¤ì •ë¨');
        fetchAlerts();
    } catch(e) { showToast('âŒ ' + e.message, false); }
}

// â”€â”€â”€ DCF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateDcfLabel() {
    document.getElementById('dcf-growth-val').textContent   = (parseFloat(document.getElementById('dcf-growth').value)*100).toFixed(0);
    document.getElementById('dcf-discount-val').textContent = (parseFloat(document.getElementById('dcf-discount').value)*100).toFixed(1);
    document.getElementById('dcf-terminal-val').textContent = (parseFloat(document.getElementById('dcf-terminal').value)*100).toFixed(1);
}
async function calcDcf() {
    const ticker   = document.getElementById('dcf-ticker').value.trim();
    const growth   = parseFloat(document.getElementById('dcf-growth').value);
    const discount = parseFloat(document.getElementById('dcf-discount').value);
    const terminal = parseFloat(document.getElementById('dcf-terminal').value);
    if (!ticker) { showToast('í‹°ì»¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”', false); return; }
    try {
        const data = await apiFetch(`/analysis/dcf-custom?ticker=${encodeURIComponent(ticker)}&growth_rate=${growth}&discount_rate=${discount}&terminal_growth=${terminal}`);
        const el = document.getElementById('dcf-result');
        el.style.display = 'block';
        document.getElementById('dcf-result-val').textContent = '$' + (data.fair_value ?? data.dcf_value ?? 0).toFixed(2);
        document.getElementById('dcf-result-note').textContent = `ì„±ì¥ë¥  ${(growth*100).toFixed(0)}% / WACC ${(discount*100).toFixed(1)}% / í„°ë¯¸ë„ ${(terminal*100).toFixed(1)}%`;
    } catch(e) { showToast('âŒ ' + e.message, false); }
}

// â”€â”€â”€ Trade Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openTradeModal() { openModal('tradeModal'); setTradeMode('buy'); }
function openTradeFor(ticker) { openTradeModal(); document.getElementById('tx-ticker').value = ticker; }
function closeTradeModal() { closeModal('tradeModal'); }

function setTradeMode(mode) {
    tradeMode = mode;
    const b = document.getElementById('btn-buy-mode');
    const s = document.getElementById('btn-sell-mode');
    if (mode === 'buy') {
        b.className = 'btn btn-success'; b.style.color = '';
        s.className = 'btn btn-outline'; s.style.color = 'var(--sub)';
    } else {
        s.className = 'btn btn-danger'; s.style.color = '';
        b.className = 'btn btn-outline'; b.style.color = 'var(--sub)';
    }
}

async function submitTrade() {
    const ticker = document.getElementById('tx-ticker').value.trim();
    const qty    = document.getElementById('tx-qty').value;
    const price  = document.getElementById('tx-price').value;
    if (!ticker || !qty || !price) { showToast('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”', false); return; }
    try {
        await apiFetch(`/portfolio/${USER}/trade?ticker=${encodeURIComponent(ticker)}&action=${tradeMode}&quantity=${qty}&price=${price}`, {method:'POST'});
        showToast('âœ… ê¸°ë¡ ì™„ë£Œ');
        closeTradeModal();
        fetchPortfolioFull();
    } catch(e) { showToast('âŒ ' + e.message, false); }
}

// â”€â”€â”€ Excel Upload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function uploadExcel() {
    const input = document.getElementById('excelInput');
    if (!input.files?.[0]) return;
    const fd = new FormData();
    fd.append('file', input.files[0]);
    fd.append('user_id', USER);
    try {
        showToast('ì—…ë¡œë“œ ì¤‘...');
        const res = await fetch(API + '/portfolio/upload', {method:'POST', body:fd});
        if (!res.ok) throw new Error((await res.json()).detail || 'ì‹¤íŒ¨');
        const data = await res.json();
        showToast('âœ… ' + (data.message||'ì—…ë¡œë“œ ì™„ë£Œ'));
        fetchPortfolioFull(true);
    } catch(e) { showToast('âŒ ' + e.message, false); }
    finally { input.value = ''; }
}

// â”€â”€â”€ Modal Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
window.addEventListener('click', e => {
    document.querySelectorAll('.modal-backdrop.open').forEach(m => { if (e.target === m) m.classList.remove('open'); });
});

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function initApp() {
    await Promise.all([
        fetchPortfolioFull(),
        fetchMacroBar(),
        fetchStrategyStatus(),
        fetchSectorWeightsMini(),
    ]);
    setInterval(() => {
        const active = document.querySelector('.nav-item.active')?.dataset?.tab;
        if (active === 'dashboard') { fetchPortfolioFull(); fetchMacroBar(); }
        if (active === 'market')    { fetchTop20(); fetchSignals(); }
    }, 30000);
}

// ì§„ì…ì : í† í° ìˆìœ¼ë©´ ì•± ì‹œì‘, ì—†ìœ¼ë©´ ë¡œê·¸ì¸ í™”ë©´
(function bootstrap() {
    if (getToken()) {
        initApp();
    } else {
        showLogin();
    }
})();
</script>
</body>
</html>
